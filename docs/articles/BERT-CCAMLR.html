<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Estimate local toothfish biomass in CCAMLR data-poor areas • BERT</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">BERT</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/BERT-CCAMLR.html">Estimate local toothfish biomass in CCAMLR data-poor areas</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Estimate local toothfish biomass in CCAMLR data-poor areas</h1>
                        <h4 class="author">Lucy Robinson</h4>
            
            <h4 class="date">2018-04-05</h4>
          </div>

    
    
<div class="contents">
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This vignette describes the <code>BERT: Biomass Estimation for Research on Toothfish package</code>. The <code>BERT</code> package was developed to assist CCAMLR’s Working Groups with the estimation of the local biomass of toothfish in Research Blocks/data-poor areas.</p>
<p>The main purpose of this package is to provide functions that:<br>
(1) can be used to estimate local biomass using the most up-to-date CPUE-by-seabed area and Chapman mark-recapture biomass estimation methods agreed by WG-FSA and WG-SAM and;<br>
(2) format the necessary CCAMLR data for input into the biomass estimation method functions</p>
<p>Methods used to estimate local toothfish biomass in the data-poor CCAMLR fisheries include a CPUE-by-seabed-area analogy method (Agnew et al, 2009) and a Chapman tag-recapture estimator (Hillary et al, 2009). Both methods have undergone modification in the working group meetings over the past 10 years with changes to formulas, fixed parameter values, appropriate time series of catch and tagging data for inclusion and the data quality and cleaning processes applied. To address this issue WG-SAM-16 agreed (and documented) a standardised default method of applying the CPUE-by-seabed area and the Chapman tag release-recapture methods of estimating biomass, and requested that the Secretariat apply these methods to provide a single set of biomass estimates of D. mawsoni or D. eleginoides in Research Blocks in Subareas 58.4 and 48.6 that could be further evaluated by WG-FSA (SC-CAMLR-XXXV, Annex 5, paragraph 2.28).</p>
<p>In this vignette provides examples of both methods that are similar in lay-out to the R-markdown developed by the Secretariat for WG-FSA-17 except instead of using “real data” we provide simulated datasets for a Research block that targets Antarctic toothfish (i.e. RB_TOA) and Research block that targets Patagonian toothfish (i.e. RB_TOP). Given data are simulated there are no data extract and processing steps included here, but see paper WG-FSA-17/42 or the R markdown document referred to above for details on these steps.</p>
<p>To work through the examples in the vignette you will need to install the BERT R package from github. In order to install from github you will firstly need to install devtools (i.e. <code>install.packages("devtools")</code>) and then use the following command:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">devtools<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/devtools/topics/install_github">install_github</a></span>(<span class="st">"ccamlr/BERT"</span>,<span class="dt">build_vignettes=</span><span class="ot">TRUE</span>,<span class="dt">auth_token=</span><span class="st">"7ef7614738c2b3463fc791d4f22a719d61be35fa"</span>)</code></pre></div>
</div>
<div id="ccamlr-data-required-for-local-toothfish-biomass-estimation" class="section level2">
<h2 class="hasAnchor">
<a href="#ccamlr-data-required-for-local-toothfish-biomass-estimation" class="anchor"></a>CCAMLR data required for local toothfish biomass estimation</h2>
<p>A brief explanation of the data that is collected in CCAMLR’s toothfish research programs that are required for local biomass estimation is provided below, but see Appendix A of WG-FSA-16/27 for more detailed metadata on each of the required data fields.</p>
<p>Catch data that are collected during toothfish research fishing, and necessary for local biomass estimation, are stored in CCAMLR’s database at a haul-by-haul resolution. Each toothfish longline that is set and hauled will have unique id (ID) and information on the set start (SET_START_DATE) and end dates (SET_END_DATE) and haul start (HAUL_START_DATE) and end (HAUL_END_DATE) dates as well as their geographic positions (e.g. SET_START_LATITUDE,SET_START_LONGITUDE, SET_END_LATITUDE,SET_END_LONGITUDE) and the length of the longline (LINE_LENGTH). The SET_START_DATE is used to assign the CCAMLR fishing season (Season) and the set start and end geographic positions are used to assign a Research Block (RESEARCH_BLOCK_CODE) or Reference Area (REF_AREA_CODE) code. Information on what species were caught (SPECIES_CODE) and their quantities (CAUGHT_KG_TOTAL) on each longline that is hauled is also recorded. The Secretariat has developed routine data extracts for catch data in Research blocks and Reference areas to be provided in csv files (see WG-FSA-16/27).</p>
<p>It is also a requirement to tag and release fish at a rate of 5 fish per tonne, in most areas, where toothfish research is being conducted. Detailed information is recorded on each fish that is tagged and released and any tagged fish recaptured. Tagged fish release data include a cruise identification number (CRUISE_ID) and haul identification number (HAUL_ID) and information on the species (SPECIES_CODE), the geographic position of the release (that is used to assign a RESEARCH_BLOCK_CODE and ASD_CODE) and the length of the fish (LENGTH_CM). Fish are not weighed when tagged, to minimise handling time, but the weight of released fish can be estimated using a modelled length-weight relationship. The estimated weight of the released fish is added to the total weight of fish retained for each haul; which is referred to as substantial catch. The Secretariat has developed routine data extracts of tagged fish release data in Research blocks and Reference areas to be stored in csv files (see WG-FSA-16/27).</p>
<p>The toothfish length and weight data required for modelling the length-weight relationship is recorded by CCAMLR’s Scientific Observers when they are collecting biological information on fish that are retained as catch. The species (SPECIES_CODE), length (LENGTH_CM) and weight of (WEIGHT_KG) fish retained from the Subarea or Division (ASD_CODE) that the Research Block or Reference Area was located in are required for modelling the length-weight relationship that is then used in estimating released fish weights. The Secretariat has developed routine data extracts of length-weight data in Research blocks and Reference areas to be stored in csv files (see WG-FSA-16/27).</p>
<p>When a tagged fish is recaptured, similar information is recorded on the recaptured fish as was recorded on its release. For the purpose of local biomass estimation, necessary data include the CCAMLR fishing season of release (SEASON_RELEASE) and recapture (SEASON_RECAPTURE), the Research Block of release (RESEARCH_BLOCK_RELEASE) and recapture (RESEARCH_BLOCK_RECAPTURE) and the cruise id (CRUISE_ID_RECAPTURE) and set id (SET_ID_RECAPTURE). The Secretariat has developed routine data extracts of matched tagged fish release and recapture data in Research blocks in csv files (see WG-FSA-16/27).</p>
<p>Local biomass is estimated annually (i.e. in each CCAMLR fishing season for which data are available). This requires summing data across hauls within a fishing season. The functions in this R package have been developed to estimate uncertainty around the annual estimates. Uncertainty is estimated through bootstrapping the haul data in a fishing season and this is why data are required at a haul-by-haul (rather than an aggregated annual) resolution.</p>
<p>The CCAMLR data necessary for both methods can be provided in the same data extracts, but the CPUE-by-seabed area method require catch, length-weight and tagged fish release data from Research blocks and Reference Areas while Chapman-mark recapture method requires catch, tagged fish release and recapture data from the Research Block. These data extracts can be provided by the CCAMLR Secretariat (see WG-FSA-16/27 for further details on data extracts), but need to be formally requested in accordance with CCAMLR’s data access rules. If data extracts are obtained in csv format from the Secretariat these can be loaded into R using the <code>load_data</code> function in the BERT package.</p>
</div>
<div id="simulated-data" class="section level2">
<h2 class="hasAnchor">
<a href="#simulated-data" class="anchor"></a>Simulated data</h2>
<p>Due to CCAMLR’s data access rules, the catch, tagged fish release, length-weight and matched tagged fish release and recapture datasets described above were simulated for this vignette to represent data from Research Block and Reference Areas that were similar to the data that would be provided in data extracts. For metadata on the four simulated datasets for Research Blocks see:</p>
<p>catch data: <code><a href="../reference/catch_data_sim_RB.html">?catch_data_sim_RB</a></code> released tagged fish data: <code><a href="../reference/release_data_sim_RB.html">?release_data_sim_RB</a></code> length and weight data: <code><a href="../reference/length_weight_data_sim_RB.html">?length_weight_data_sim_RB</a></code> matched tagged fish release and recapture: <code><a href="../reference/recapture_data_sim_RB.html">?recapture_data_sim_RB</a></code></p>
<p>And for the three Reference Areas datasets see: catch data: <code><a href="../reference/catch_data_sim_RefArea.html">?catch_data_sim_RefArea</a></code> released tagged fish data: <code><a href="../reference/release_data_sim_RefArea.html">?release_data_sim_RefArea</a></code> length and weight data: <code><a href="../reference/length_weight_data_sim_RefArea.html">?length_weight_data_sim_RefArea</a></code></p>
<p>For code to re-simulate data see inst/create_sim_data.R</p>
</div>
<div id="estimating-weight-of-released-tagged-fish-from-observer-length-weight-data" class="section level2">
<h2 class="hasAnchor">
<a href="#estimating-weight-of-released-tagged-fish-from-observer-length-weight-data" class="anchor"></a>Estimating weight of released tagged fish from observer length-weight data</h2>
<p>Fish that are tagged and released are not weighed, but their length is measured. Weights from these released fish are required to estimate the total catch (i.e. not just retained catch) for both the CPUE-by-seabed area and the Chapman mark-recapture biomass estimation methods.</p>
<p>The weights of released fish are estimated using a log-liner model, that is parameterised using length and weight data collected by observers on retained catch (i.e. the length-weight data from the ASD that the Research block is situated in is used to parameterise this model). This is done using the <code>est_fish_weight</code> function.</p>
<p>Using the simulated release data and length-weight data from Research Blocks and Reference Areas. The weights of tagged fish releases are estimated and added to the existing data frames as EST_WEIGHT_KG For input requirements for this function see the example below and/or <code><a href="../reference/est_fish_weight.html">?est_fish_weight</a></code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># load BERT package</span>
<span class="kw">library</span>(BERT)

<span class="co"># select length_weight data fields in release data required for input into the est_fish_weight function</span>

data_store_release_RB_input &lt;-<span class="st"> </span><span class="kw">data.frame</span>(release_data_sim_RB<span class="op">$</span>ASD_CODE,release_data_sim_RB<span class="op">$</span>SEASON,
                                          release_data_sim_RB<span class="op">$</span>CRUISE_ID,release_data_sim_RB<span class="op">$</span>SET_ID,
                                          release_data_sim_RB<span class="op">$</span>SPECIES_CODE,release_data_sim_RB<span class="op">$</span>LENGTH_CM)

release_data_sim_RB<span class="op">$</span>EST_WEIGHT_KG &lt;-<span class="st"> </span><span class="kw"><a href="../reference/est_fish_weight.html">est_fish_weight</a></span>(<span class="dt">length_weight_data =</span> length_weight_data_sim_RB,
                                                     <span class="dt">length_data =</span> data_store_release_RB_input)

<span class="co"># do the same for Reference Area tagged fish releases</span>

data_store_release_RefArea_input &lt;-<span class="st"> </span><span class="kw">data.frame</span>(release_data_sim_RefArea<span class="op">$</span>ASD_CODE,release_data_sim_RefArea<span class="op">$</span>SEASON,
                                               release_data_sim_RefArea<span class="op">$</span>CRUISE_ID,release_data_sim_RefArea<span class="op">$</span>SET_ID,
                                               release_data_sim_RefArea<span class="op">$</span>SPECIES_CODE,release_data_sim_RefArea<span class="op">$</span>LENGTH_CM)

release_data_sim_RefArea<span class="op">$</span>EST_WEIGHT_KG &lt;-<span class="st"> </span><span class="kw"><a href="../reference/est_fish_weight.html">est_fish_weight</a></span>(<span class="dt">length_weight_data =</span> length_weight_data_sim_RefArea,
                                                          <span class="dt">length_data =</span> data_store_release_RefArea_input)</code></pre></div>
</div>
<div id="cpue-by-seabed-area-biomass-estimation" class="section level2">
<h2 class="hasAnchor">
<a href="#cpue-by-seabed-area-biomass-estimation" class="anchor"></a>CPUE-by-seabed area biomass estimation</h2>
<p>The point estimation of local biomass using the catch-per-unit-effort (CPUE) by seabed area analogy was agreed at WG-SAM-16; 2.28 and defined as</p>
<p><span class="math display">\[ B_x = \frac{I_x \times A_x \times B_r}{I_r \times Ar} \]</span></p>
<p>Where the subscripts <span class="math inline">\(x\)</span> and <span class="math inline">\(r\)</span> denote the parameter from the research block and reference area respectively. Different reference areas were selected for Research Blocks depending on the target species. WG-SAM-16 agreed that the Ross Sea Region (<strong>88.1, 88.2 and the units</strong> ) should be used as a reference area for Research Blocks that target D.mawsoni and the HIMI area (Division 58.5.2) should be used as a reference area for Research Blocks that target D.eleginoides (WG-SAM-16, para 2.30).</p>
<p><span class="math inline">\(Ix\)</span> is the median of the haul-by-haul CPUE (kg/km) over the past three seasons in which fishing has occurred in Research Block <span class="math inline">\(x\)</span>. For example, if fishing had occurred in Research block <span class="math inline">\(x\)</span> in 2017, 2015 and 2014, then all of these hauls will be included in calculating the median CPUE for the 2017 fishing season.</p>
<p><span class="math inline">\(Ir\)</span> is the median of the haul by haul CPUE (kg/km) over the past three seasons in the relevant Reference Area that relates to the season of the stock assessment that was used to generate the reference area Biomass <span class="math inline">\(r\)</span>. For example if the 2017 assessment was used to generate the reference area biomass then hauls from the 2017,2016 and 2015 seasons would be included</p>
<p>In both <span class="math inline">\(Ix\)</span> and <span class="math inline">\(Ir\)</span> The total fish weight included in the CPUE included the total catch (kg) on a haul, includes fish that were tagged and released (where the weight of released fish is estimated using the length–weight relationship for that area) is divided by the length of line (km) reported for that set (WG-SAM-16, paragraph 2.36).</p>
<p><span class="math inline">\(Ax\)</span> is the seabed area (km2) in Research Block x in the depth range 600–1800 m using a processed version of the GEBCO 2014 dataset.<span class="math inline">\(Ar\)</span> is the seabed area (km2) in the same depth range (i.e. 600-1800m) in the reference area <span class="math inline">\(r\)</span>. Consistent with advice from WG-SAM-17, the seabed area included in the Ross Sea reference area (i.e. RSR_open) only included Small Scale Research Units (SSRUs) that are open to fishing (para 3.11, WG-SAM-17). In the HIMI reference area <span class="math inline">\(Ar\)</span>=117067.75 km2 and in the RSR_open reference area <span class="math inline">\(Ar\)</span>=120928.75 km2. <span class="math inline">\(Br\)</span> was the current vulnerable biomass (para 3.10 WG-SAM-17) from the 2017 integrated assessments in the Ross Sea, which was estimated to be 92693.07 t of Antarctic toothfish, and the HIMI assessment, which were estimated to be 43993.03 t of Patagonian toothfish. Variation in the reference areas biomass estimates were included with CV values of 0.073 from the Ross Sea Assessment and 0.072 from the HIMI Assessment. Mean and CV values were provided by New Zealand Scientists for the Ross Sea Assessment and Australian Scientists for the HIMI assessment.</p>
<p>The uncertainty around the point estimates was calculated using a non-parametric bootstrap (Efron and Tibshirani 1993; Chernick 2008). The following steps were applied</p>
<ol style="list-style-type: decimal">
<li>The hauls for the research block and the reference area are sampled with replacement. Noting that if there were zero catch hauls, these are included in bootstrap resampling.<br>
</li>
<li>Median values,<span class="math inline">\(I^i_x\)</span> and <span class="math inline">\(I^i_r\)</span>, calculated for each the ith bootstrap replicates.<br>
</li>
<li>The uncertainty in the reference area biomass was quantified by generating a log normally distributed random number with mean <span class="math inline">\(B_r\)</span> and a standard deviation that is the square root of the coefficient of variation of <span class="math inline">\(B_r\)</span>.<br>
For each ith bootstrap replicate we calculate biomass, as</li>
</ol>
<p><span class="math display">\[ B^i_x = \frac{I^i_x \times A_x \times B^i_r}{I^i_r \times A_r}. \]</span></p>
<p>The areas of the research block and the reference area (<span class="math inline">\(A_x\)</span>,<span class="math inline">\(A_r\)</span>) were assumed to be known without error and are therefore not contributed to the uncertainty in the bootstrap. See <code><a href="../reference/CPUE_seabed.html">?CPUE_seabed</a></code></p>
<p>The uncertainty is then quantified by taking quantiles of the <span class="math inline">\(B^i_x\)</span>, for example, 95% confidence intervals are the 0.025 and 0.975 quantiles.</p>
</div>
<div id="cpue-by-seabed-area-biomass-estimation-of-antarctic-toothfish-in-research-block-rb_toa" class="section level2">
<h2 class="hasAnchor">
<a href="#cpue-by-seabed-area-biomass-estimation-of-antarctic-toothfish-in-research-block-rb_toa" class="anchor"></a>CPUE-by-seabed area biomass estimation of Antarctic toothfish in Research Block RB_TOA</h2>
<p>In this example toothfish biomass is estimated using the CPUE-by-seabed area method in RB_TOA based on simulated data and the estimated released fish weights described above.</p>
<p>Data from Research block RB_TOA are selected</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># use RB as an index </span>
RB &lt;-<span class="st"> "RB_TOA"</span>

<span class="co"># restrict Release data to relevant research block </span>
Release_data_RB &lt;-<span class="st"> </span>release_data_sim_RB[release_data_sim_RB[[<span class="st">"RESEARCH_BLOCK_CODE"</span>]]<span class="op">%in%</span>RB,]

<span class="co"># restrict data to the relevant Research Block    </span>
Catch_data_RB &lt;-<span class="st"> </span>catch_data_sim_RB[catch_data_sim_RB[[<span class="st">"RESEARCH_BLOCK_CODE"</span>]]<span class="op">%in%</span>RB,]</code></pre></div>
<p>Research Blocks where TOP is targeted is specified and the inverse of this infers that TOA is targeted. In this example the target species will be TOA</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># note only 3 Research Blocks currently target TOP and all others target TOA</span>
TOP_target_RBs &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"RB_TOP"</span>,<span class="st">"5844b_1"</span>,<span class="st">"5844b_2"</span>)
## make sure you specifiy target species data 
target_species &lt;-<span class="st"> </span><span class="kw">ifelse</span>(RB<span class="op">%in%</span>TOP_target_RBs,<span class="st">"TOP"</span>,<span class="st">"TOA"</span>)</code></pre></div>
<p>Tagged fish release and catch data in Research Block RB_TOA is subset to include only columns of data that are relevant to the CPUE-by-seabed area estimates</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># select data for input into biomass estimate function see ?extract_catch_data_cpue_est param release_data</span>
Release_data_RB &lt;-<span class="st"> </span><span class="kw">data.frame</span>(Release_data_RB<span class="op">$</span>SEASON,Release_data_RB<span class="op">$</span>CRUISE_ID,
                              Release_data_RB<span class="op">$</span>SET_ID,Release_data_RB<span class="op">$</span>SPECIES_CODE,Release_data_RB<span class="op">$</span>EST_WEIGHT_KG)

<span class="co"># select data for input into biomass estimate function see ?extract_catch_data_cpue_est param catch_data</span>
Catch_data_RB&lt;-<span class="st"> </span><span class="kw">data.frame</span>(Catch_data_RB<span class="op">$</span>ID,Catch_data_RB<span class="op">$</span>Season,Catch_data_RB<span class="op">$</span>CRUISE_ID,
                           Catch_data_RB<span class="op">$</span>SET_ID,Catch_data_RB<span class="op">$</span>SPECIES_CODE,Catch_data_RB<span class="op">$</span>CAUGHT_KG_TOTAL,
                           Catch_data_RB<span class="op">$</span>LINE_LENGTH)</code></pre></div>
<p>The Reference Areas for a Research Block is based on the species that is being targetted. As outlined in the general methods above the Reference Area for Research Blocks where TOA are targetted is the Ross Sea Region (RSR). Hence if the Research Block does not target TOP, then it targets TOA and the the <code>Ref_area</code> is “RSR”</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Ref_area &lt;-<span class="st"> </span><span class="kw">ifelse</span>(RB<span class="op">%in%</span>TOP_target_RBs,<span class="st">"HIMI"</span>,<span class="st">"RSR"</span>)</code></pre></div>
<p>Data from the Relevant Reference Area (i.e. the Ross Sea Region) are selected</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Release_data_RefArea &lt;-<span class="st"> </span>release_data_sim_RefArea[release_data_sim_RefArea[[<span class="st">"REF_AREA_CODE"</span>]]<span class="op">%in%</span>Ref_area,]


Catch_data_RefArea &lt;-<span class="st"> </span>catch_data_sim_RefArea[catch_data_sim_RefArea[[<span class="st">"REF_AREA_CODE"</span>]]<span class="op">%in%</span>Ref_area,]</code></pre></div>
<p>Tagged fish release and catch data from the Reference Area are subset to include only columns that are relevant to the CPUE-by-seabed area estimates</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># select data for input into biomass estimate function see ?extract_catch_data_cpue_est param release_data</span>
Release_data_RefArea &lt;-<span class="st"> </span><span class="kw">data.frame</span>(Release_data_RefArea<span class="op">$</span>SEASON,Release_data_RefArea<span class="op">$</span>CRUISE_ID,
                                   Release_data_RefArea<span class="op">$</span>SET_ID,Release_data_RefArea<span class="op">$</span>SPECIES_CODE,
                                   Release_data_RefArea<span class="op">$</span>EST_WEIGHT_KG)

Catch_data_RefArea &lt;-<span class="st"> </span><span class="kw">data.frame</span>(Catch_data_RefArea<span class="op">$</span>ID,Catch_data_RefArea<span class="op">$</span>Season,Catch_data_RefArea<span class="op">$</span>CRUISE_ID,
                                 Catch_data_RefArea<span class="op">$</span>SET_ID,Catch_data_RefArea<span class="op">$</span>SPECIES_CODE,
                                 Catch_data_RefArea<span class="op">$</span>CAUGHT_KG_TOTAL,Catch_data_RefArea<span class="op">$</span>LINE_LENGTH)</code></pre></div>
<p>If the Reference Area is “RSR” then the Reference area biomass (i.e. <code>Ref_area_biomass</code>) is 92693.07 tonnes - as this was the estimated vulnerable biomass from the 2017 stock assessment. The <code>Ref_area_CV</code> from the Ross Sea stock assessement for the vulnerable biomass was 0.073</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># 2017 values from WG-FSA-17</span>
Ref_area_biomass &lt;-<span class="kw">ifelse</span>(Ref_area<span class="op">%in%</span><span class="st">"HIMI"</span>,<span class="fl">43993.03</span>,<span class="fl">92693.07</span>)

Ref_area_CVs &lt;-<span class="kw">ifelse</span>(Ref_area<span class="op">%in%</span><span class="st">"HIMI"</span>,<span class="fl">0.072</span>,<span class="fl">0.073</span>)</code></pre></div>
<p>Annual estimates are made for each CCAMLR fishing season for which data are available and all parameter values that are used in calculating biomass are stored with each estimate in <code>store_annual_estimates</code>. <code>Survey_est</code> are the seasons for which catch data were available, which makes estimation of biomass possible. In this example there is only a single year of data included so there is only one annual estimate.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Survey_est&lt;-<span class="st"> </span><span class="kw">sort</span>(<span class="kw">unique</span>(Catch_data_RB<span class="op">$</span>Catch_data_RB.Season))


store_annual_estimates&lt;-<span class="kw">data.frame</span>(<span class="kw">matrix</span>(<span class="dv">0</span>,<span class="dt">nrow=</span><span class="kw">length</span>(Survey_est),<span class="dt">ncol=</span><span class="dv">11</span>))
<span class="kw">names</span>(store_annual_estimates)=<span class="kw">c</span>(<span class="st">"RB"</span>,<span class="st">"Species"</span>,<span class="st">"Season"</span>,<span class="st">"Ref_area"</span>,<span class="st">"RefArea_seabed_area"</span>,
                                <span class="st">"RefArea_N_Hauls"</span>,<span class="st">"RB_seabedarea"</span>,<span class="st">"RB_N_Hauls"</span>,<span class="st">"Est"</span>,<span class="st">"CI_lower"</span>,<span class="st">"CI_upper"</span>)


store_annual_estimates<span class="op">$</span>Season &lt;-<span class="st"> </span>Survey_est</code></pre></div>
<p>In Research Blocks the median CPUE can includes data from the last three seasons in which fishing occured. Depending on the season for which biomass is being estimated (i.e. <span class="math inline">\(y\)</span>) data from all seasons will be included if there are less than three seasons, but if there are more than three seasons of data then this is restricted to the last three years.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">for</span> (y <span class="cf">in</span> Survey_est){
  
  <span class="co"># select the last three seasons in which fishing occurred </span>
  Seasons &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">min</span>(Survey_est),y,<span class="dv">1</span>)
  
  <span class="cf">if</span>(<span class="kw">length</span>(Seasons)<span class="op">&gt;</span><span class="dv">3</span>){Seasons &lt;-<span class="st"> </span>Survey_est[(<span class="kw">which</span>(Survey_est<span class="op">%in%</span>y)<span class="op">-</span><span class="dv">2</span>)<span class="op">:</span><span class="kw">which</span>(Survey_est<span class="op">%in%</span>y)]
  }<span class="cf">else</span>{Seasons &lt;-<span class="st"> </span>Survey_est[<span class="dv">1</span><span class="op">:</span><span class="kw">which</span>(Survey_est<span class="op">%in%</span>y)]}
  
}</code></pre></div>
<p>With the relevant seasons to include in Research Blocks specified, the <code>extract_catch_data_cpue_est</code> function uses the catch data and tagged fish release data from Research Blocks to format CPUE data for input into the <code>CPUE_seabed</code> function below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">RB_haul_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/extract_catch_data_cpue_est.html">extract_catch_data_cpue_est</a></span>(<span class="dt">catch_data=</span>Catch_data_RB,<span class="dt">release_data=</span>Release_data_RB,
                                            <span class="dt">measure =</span><span class="st">"weights"</span>,<span class="dt">target_species =</span> target_species,
                                            <span class="dt">catch_season =</span> Seasons)</code></pre></div>
<p>The first six hauls from the single vector of simulated CPUE values from RB_TOA for the 2017 season looks like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(RB_haul_data) 
<span class="co">#&gt; [1] 154.51985 106.31354 111.66144 185.84834  97.31474  83.08652</span></code></pre></div>
<p>The seasons for which CPUE values should be calculated in Reference Areas is specified below. Given the most recent estimated vulnerable biomass in the Reference Areas are from 2017 and the Reference Area is the Ross Sea Region then CPUE values from each haul over the last three seasons (i.e. 2017,2016 and 2015) are included, but given only data from 2017 were simulated then only one seasons of data is included</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># get hauls in last 3 seasons in the Reference Areas that match the latest assessment period</span>
<span class="co"># for HIMI 2017 hauls are excluded because the season and data were considered incomplete, </span>
<span class="co"># but for the simulation we assume complete data in 2017</span>

Ref_area_seasons &lt;-<span class="kw">c</span>(<span class="dv">2015</span>,<span class="dv">2016</span>,<span class="dv">2017</span>)</code></pre></div>
<p>With the relevant seasons to include in the Reference Area specified, the <code>extract_catch_data_cpue_est</code> function uses the simulated catch data and tagged fish release data from the Ross Sea Reference area to format CPUE data for input into the <code>CPUE_seabed</code> function below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">RefArea_haul_data_test &lt;-<span class="st"> </span><span class="kw"><a href="../reference/extract_catch_data_cpue_est.html">extract_catch_data_cpue_est</a></span>(<span class="dt">catch_data=</span>Catch_data_RefArea,
                                                      <span class="dt">release_data=</span>Release_data_RefArea,
                                                      <span class="dt">measure =</span><span class="st">"weights"</span>,
                                                      <span class="dt">target_species =</span> target_species,
                                                      <span class="dt">catch_season =</span> Ref_area_seasons)</code></pre></div>
<p>Fishable seabed area values for a number of Research Blocks are stored in the <code>BERT</code> R package as a two column dataframe called RB_seabed_area. The first column contains the Research Block codes that were used in calculating biomass estimates for WG-FSA-17 and the second column includes the planimetric seabed area values. In the example below the <code>RB_seabed_area</code> parameter value is selected for Research Block RB_TOA. For further information on this data see <code><a href="../reference/RB_seabed_area.html">?RB_seabed_area</a></code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># remove survey year col from the matrix for input into multi release function</span>
RB_Seabed_area &lt;-<span class="st"> </span>RB_seabed_area<span class="op">$</span>Seabed_area[RB_seabed_area<span class="op">$</span>RB<span class="op">%in%</span>RB]</code></pre></div>
<p>Fishable seabed area values for Reference Areas are also stored in the <code>BERT</code> R package as a two column dataframe called <code>Ref_area_seabed_area</code>. The first column contains the Reference Area codes that were used in calculating biomass estimates for WG-FSA-17 and the second column includes the planimetric seabed area values for each Research Block. Given it was agreed at WG-SAM-17 the seabed area in the Ross Sea Reference Area should only include those areas that are open to fishing, the “RSR_open” area is selected. For further information on these data see ?<code>Ref_area_seabed_area</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># change Reference area seabed area RSR_open</span>
<span class="cf">if</span>(Ref_area<span class="op">==</span><span class="st">"RSR"</span>){
  RefArea_Seabed_area &lt;-Ref_area_seabed_area<span class="op">$</span>Seabed_area[Ref_area_seabed_area<span class="op">$</span>RefArea<span class="op">%in%</span><span class="st">"RSR_open"</span>]
}<span class="cf">else</span>{
  RefArea_Seabed_area &lt;-Ref_area_seabed_area<span class="op">$</span>Seabed_area[Ref_area_seabed_area<span class="op">$</span>RefArea<span class="op">%in%</span>Ref_area]
}</code></pre></div>
<p>Specify number of bootstrap replicates</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># number of bootstrap replicate samples</span>
n_boot &lt;-<span class="st"> </span><span class="dv">10000</span></code></pre></div>
<p>The point CPUE-by-seabed area biomass estimate of TOA in RB_TOA (i.e. Est) for the 2017 season is calculated using the <code>cpue_bio</code> function that accepts a single value for each parameter input. The <code>cpue_bio</code> function is called by the <code>CPUE_seabed</code> function that accepts vector data (which is the haul-by-haul) for catch data inputs. The <code>CPUE_seabed</code> function returns the point estimate in <code>obj$est</code>. The output from the <code>cpue_bootrap</code> function stored in <code>CPUE_seabed_boot</code> also returns the point estimate in <code>summary(CPUE_seabed_boot)["Est"]</code> and the lower 95% confidence interval in <code>summary(CPUE_seabed_boot)["2.5%"]</code> and upper 95% confidence interval in <code>summary(CPUE_seabed_boot)["97.5%"]</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">obj &lt;-<span class="st"> </span><span class="kw"><a href="../reference/CPUE_seabed.html">CPUE_seabed</a></span>(<span class="dt">fish_CPUE_data=</span>RB_haul_data,<span class="dt">fish_area=</span>RB_Seabed_area,
                   <span class="dt">ref_CPUE_data=</span>RefArea_haul_data_test,
                   <span class="dt">ref_area=</span>RefArea_Seabed_area,<span class="dt">ref_bio=</span>Ref_area_biomass,<span class="dt">ref_bio_cv =</span> Ref_area_CVs)

CPUE_seabed_boot &lt;-<span class="st"> </span><span class="kw"><a href="../reference/cpue_bootstrap.html">cpue_bootstrap</a></span>(obj,n_boot)

store_annual_estimates<span class="op">$</span>RB[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span>RB
store_annual_estimates<span class="op">$</span>Species[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span><span class="kw">as.character</span>(target_species)
store_annual_estimates<span class="op">$</span>Ref_area[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span>Ref_area
store_annual_estimates<span class="op">$</span>RefArea_seabed_area[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span>RefArea_Seabed_area
store_annual_estimates<span class="op">$</span>RefArea_biomass[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span>Ref_area_biomass
store_annual_estimates<span class="op">$</span>RefArea_N_Hauls[Survey_est<span class="op">%in%</span>y] &lt;-<span class="kw">length</span>(RefArea_haul_data_test)
store_annual_estimates<span class="op">$</span>RefArea_CPUE[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(obj<span class="op">$</span>data[<span class="st">"ref_CPUE_est"</span>])
store_annual_estimates<span class="op">$</span>RB_seabedarea[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span>RB_Seabed_area
store_annual_estimates<span class="op">$</span>RB_N_Hauls[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span><span class="kw">length</span>(RB_haul_data)
store_annual_estimates<span class="op">$</span>RB_CPUE[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span><span class="kw">as.numeric</span>(obj<span class="op">$</span>data[<span class="st">"fish_CPUE_est"</span>])
store_annual_estimates<span class="op">$</span>Est[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span><span class="kw">summary</span>(CPUE_seabed_boot)[<span class="st">"Est"</span>]
store_annual_estimates<span class="op">$</span>CI_lower[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span><span class="kw">summary</span>(CPUE_seabed_boot)[<span class="st">"2.5%"</span>]
store_annual_estimates<span class="op">$</span>CI_upper[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span><span class="kw">summary</span>(CPUE_seabed_boot)[<span class="st">"97.5%"</span>]


store_biomass_estimates_CPUE &lt;-<span class="st"> </span><span class="kw">subset</span>(store_annual_estimates,<span class="dt">select=</span> <span class="kw">c</span>(RB,Species,Season,RB_N_Hauls,Est,CI_lower,CI_upper))
store_biomass_estimates_CPUE<span class="op">$</span>Method&lt;-<span class="kw">rep</span>(<span class="st">"CPUE-by-seabed area"</span>,<span class="kw">nrow</span>(store_biomass_estimates_CPUE))</code></pre></div>
</div>
<div id="chapman-mark-recapture-estimator" class="section level2">
<h2 class="hasAnchor">
<a href="#chapman-mark-recapture-estimator" class="anchor"></a>Chapman mark-recapture estimator</h2>
<p>The point estimation of local biomass using the Chapman mark-recapture-based method was agreed at WG-SAM-16; 2.28 and defined as:</p>
<p><span class="math display">\[B_j = \frac{c_j(n_{j-1}+1)}{mx_j+1}\]</span></p>
<p>where <span class="math inline">\(n_{j–1}\)</span> is the number of tagged fish available for recapture at the end of the season prior to season <span class="math inline">\(j\)</span>, <span class="math inline">\(c_j\)</span> is the catch in season <span class="math inline">\(j\)</span> (as with CPUE the catch includes fish that are tagged and released, as these fish are scanned for tags upon capture) and <span class="math inline">\(mx_j\)</span> is the number of tagged fish recaptured in season <span class="math inline">\(j\)</span> (excluding within-season recaptures).</p>
<p>The agreed calculation for the number of tagged fish available for recapture is:</p>
<p><span class="math display">\[
N_j =
\begin{cases}
j=1, r_j(1-t)e^{-(f+M)}-m_j                       
\\
j&gt;1, n_{j-1}
\end{cases}
\]</span></p>
<p><span class="math inline">\(r_j\)</span> is the total number of fish released in CCAMLR fishing season <span class="math inline">\(j\)</span>, <span class="math inline">\(m_j\)</span> is the total number of tagged fish recaptured in CCAMLR fishing season <span class="math inline">\(j\)</span> and <span class="math inline">\(n_{j–1}\)</span> is the number of tagged fish available for recapture at the end of the season prior to season <span class="math inline">\(j\)</span>, <span class="math inline">\(t\)</span> is the post-tagging mortality rate of 0.1 (Agnew 2006), <span class="math inline">\(f\)</span> is the annual tag loss rate which is 0.0084 (WG-SAM-11/18) <span class="math inline">\(M\)</span> is natural mortality where <span class="math inline">\(M\)</span> = 0.13 for Antarctic toothfish (<em>D. mawsoni</em>) (WG-FSA-SAM-06/08) and 0.155 for Patagonian toothfish (<em>D. eleginoides</em>) (Candy 2011).</p>
<p>In the absence of an estimate of movement, the number of tagged fish available for recapture was calculated using a three-year moving window that was applied to release data to account for potential movement-related bias (SC-CAMLR-XXXV/05, paragraph 2.34). However, WG-FSA-17 agreed that only tagged fish that had been at liberty for 1 year should be included in the tagged fish available for recapture estimates in Research Blocks 486_2 and 486_3 (WG-FSA-17, paragraph 4.80). Different functions are called in this R package depending on whether multiple years of tagged fish releases or just a single year of tagged fish releases are included in biomass estimation. When only a single year of tagged fish releases are included in estimates then the <code>single_release</code> function should be used and when multiple years of tagged fish releases are included the <code>multi_release</code> function should be used.</p>
<p>The uncertainty around the point estimates was calculated using a non-parametric bootstrap (Efron and Tibshirani 1993; Chernick 2008). This uncertainty in the estimate is made up of two components. Firstly there is uncertainty in the expected number tagged fish that are available for recapture immediately prior to fishing for the assumed values of tag-induced mortality, tag-loss and natural mortality. In the estimation of this uncertainty, the probability that a tagged fish will survive tagging, natural mortality and not lose its tags is assumed independent from other tagged fish. We undertook the following steps, implementing the probability of each tagged fish surviving the tagging process and the annual natural morality and tag loss as Bernoulli trials (Binomial probabilities).</p>
<ol style="list-style-type: decimal">
<li>Tag release mortality is applied in the season of release</li>
<li>The recaptures are removed and scaled by the tag-reporting rate, noting that tag-reporting rate is currently assumed to be 100%.</li>
<li>Natural mortality and tag loss are applied</li>
</ol>
<p>Steps 2 and 3 were then repeated for each season that the tags are at liberty, but tag release mortality is only applied in the first season. For the ith bootstrap replicate this represents the <span class="math inline">\(n^i_{j–1}\)</span>. All processes (e.g. tag-induced mortality, natural mortality, tag-loss) were implemented as instantaneous rates to account for processes such as natural mortality and tag-loss that compete with one another to decrease the number of available tags over the season.</p>
<p>Secondly, we need to account for the uncertainty in the haul data. If the experiment was repeated we would not expect to recapture the same number of tagged fish. To account for this uncertainty in the bootstrap the following process is applied</p>
<ol style="list-style-type: decimal">
<li>The hauls in the season were sampled with replacement. Noting that zero tagged-fish recapture and zero catch hauls were included in bootstrapped resampling.</li>
<li>The sum of the catches and the recaptures in the ith bootstrap replicate were calculated as the <span class="math inline">\(c^i_j\)</span> and <span class="math inline">\(mx^i_j\)</span> respectively.</li>
</ol>
<p>Bootstrap replicates of the haul data where there were zero tag recaptures were used to estimate biomass (<span class="math inline">\(B^i_j\)</span>). If the Petersen method had been used the would have been infinite.</p>
<p>For each bootstrap iteration was calculated as:</p>
<p><span class="math display">\[B^i_j = \frac{c^i_j(n^i_{j-1}+1)}{mx^i_j+1}\]</span></p>
<p>The uncertainty was then quantified by taking quantiles of the <span class="math inline">\(B^i_x\)</span>, for example, 95% confidence intervals are the 0.025 and 0.975 quantiles.</p>
<p>Note that in the results the TOA abbreviation for D.mawsoni (TOA) and D.eleginoides (TOP) are used consistently throughout the results below.</p>
</div>
<div id="chapman-mark-recapture-biomass-estimation-of-patagonian-toothfish-in-research-block-rb_top" class="section level2">
<h2 class="hasAnchor">
<a href="#chapman-mark-recapture-biomass-estimation-of-patagonian-toothfish-in-research-block-rb_top" class="anchor"></a>Chapman mark-recapture biomass estimation of Patagonian toothfish in Research Block RB_TOP</h2>
<p>In this example toothfish biomass is estimated using the Chapman mark-recapture method in RB_TOP based on simulated data and the estimated released fish weights described above.</p>
<p>Specify number of bootstrap replicates</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># number of bootstrap replicate samples</span>
n_boot &lt;-<span class="st"> </span><span class="dv">10000</span></code></pre></div>
<p>Remove within season recaptures and recaptures that were released in different research blocks</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">### Estimate local biomass using the Chapman mark-recapture method
<span class="co"># remove within season recaptures </span>
recapture_data_sim_RB &lt;-<span class="st"> </span>recapture_data_sim_RB[recapture_data_sim_RB<span class="op">$</span>SEASON_RECAPTURE<span class="op">!=</span>recapture_data_sim_RB<span class="op">$</span>SEASON_RELEASE,]

<span class="co"># recaptures must be from the same research block of release</span>
recapture_data_sim_RB &lt;-<span class="st"> </span>recapture_data_sim_RB[recapture_data_sim_RB<span class="op">$</span>RESEARCH_BLOCK_CODE_RECAPTURE<span class="op">%in%</span>
<span class="st">                                                 </span>recapture_data_sim_RB<span class="op">$</span>RESEARCH_BLOCK_CODE_RELEASE,]

recapture_data_sim_RB &lt;-<span class="st"> </span><span class="kw">droplevels</span>(recapture_data_sim_RB[<span class="op">!</span><span class="kw">is.na</span>(recapture_data_sim_RB<span class="op">$</span>RESEARCH_BLOCK_CODE_RECAPTURE),])</code></pre></div>
<p>Select data from Research Block RB_TOP</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># define Research blocks </span>
RB &lt;-<span class="st"> "RB_TOP"</span>


Recapture_data &lt;-<span class="st"> </span>recapture_data_sim_RB[recapture_data_sim_RB[[<span class="st">"RESEARCH_BLOCK_CODE_RELEASE"</span>]]<span class="op">%in%</span>RB <span class="op">&amp;</span><span class="st"> </span>recapture_data_sim_RB[[<span class="st">"RESEARCH_BLOCK_CODE_RECAPTURE"</span>]]<span class="op">%in%</span>RB,]

Release_data &lt;-<span class="st"> </span>release_data_sim_RB[release_data_sim_RB[[<span class="st">"RESEARCH_BLOCK_CODE"</span>]]<span class="op">%in%</span>RB,]

Catch_data &lt;-<span class="st"> </span>catch_data_sim_RB[catch_data_sim_RB[[<span class="st">"RESEARCH_BLOCK_CODE"</span>]]<span class="op">%in%</span>RB,]</code></pre></div>
<p>Tagged fish releases, recaptures and catch data for Research Block RB_TOP are subset to include only fields that are relevant to the Chapman mark-recapture estimates</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Catch_data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(Catch_data<span class="op">$</span>ID,Catch_data<span class="op">$</span>Season,Catch_data<span class="op">$</span>CRUISE_ID,Catch_data<span class="op">$</span>SET_ID,
                         Catch_data<span class="op">$</span>SPECIES_CODE,Catch_data<span class="op">$</span>CAUGHT_KG_TOTAL)
<span class="kw">names</span>(Catch_data) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"ID"</span>,<span class="st">"Season"</span>,<span class="st">"CRUISE_ID"</span>,<span class="st">"SET_ID"</span>,<span class="st">"SPECIES_CODE"</span>,<span class="st">"CAUGHT_KG_TOTAL"</span>)
Release_data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(Release_data<span class="op">$</span>SEASON,Release_data<span class="op">$</span>CRUISE_ID,Release_data<span class="op">$</span>SET_ID,
                           Release_data<span class="op">$</span>SPECIES_CODE,Release_data<span class="op">$</span>EST_WEIGHT_KG)
<span class="kw">names</span>(Release_data) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"SEASON"</span>,<span class="st">"CRUISE_ID"</span>,<span class="st">"SET_ID"</span>,<span class="st">"SPECIES_CODE"</span>,<span class="st">"EST_WEIGHT_KG"</span>)
Recapture_data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(Recapture_data<span class="op">$</span>SEASON_RELEASE,Recapture_data<span class="op">$</span>SEASON_RECAPTURE,
                             Recapture_data<span class="op">$</span>CRUISE_ID_RECAPTURE,Recapture_data<span class="op">$</span>SET_ID_RECAPTURE,
                             Recapture_data<span class="op">$</span>SPECIES_CODE_RECAPTURE)
<span class="kw">names</span>(Recapture_data)&lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"SEASON_RELEASE"</span>,<span class="st">"SEASON_RECAPTURE"</span>,<span class="st">"CRUISE_ID_RECAPTURE"</span>,<span class="st">"SET_ID_RECAPTURE"</span>,<span class="st">"SPECIES_CODE_RECAPTURE"</span>)</code></pre></div>
<p>Specify the target species. In this example it will be TOP as RB_TOP is a Research Block where TOP are targeted</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># ensure only data from the relevant RB is included </span>
target_species&lt;-<span class="kw">ifelse</span>(RB<span class="op">%in%</span>TOP_target_RBs,<span class="st">"TOP"</span>,<span class="st">"TOA"</span>)</code></pre></div>
<p>In this example tagged fish recaptures that have been at liberty for up to 3 years are included</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span>(RB<span class="op">%in%</span><span class="kw">c</span>(<span class="st">"486_2"</span>,<span class="st">"RB_TOA"</span>)){
  <span class="co"># for 486_2 and RB_TOA WG-FSA-17 agreed tagged fish should only be 1 yr at liberty </span>
  <span class="co"># so only include recaptures from the previous year of release</span>
  Recapture_data &lt;-<span class="st"> </span>Recapture_data[Recapture_data<span class="op">$</span>SEASON_RECAPTURE<span class="op">-</span>Recapture_data<span class="op">$</span>SEASON_RELEASE<span class="op">==</span><span class="dv">1</span>,]
}<span class="cf">else</span>{ <span class="co"># all other RBs recaptures are limited within 3 years of release</span>
  Recapture_data &lt;-<span class="st"> </span>Recapture_data[Recapture_data<span class="op">$</span>SEASON_RECAPTURE<span class="op">-</span>Recapture_data<span class="op">$</span>SEASON_RELEASE<span class="op">&lt;=</span><span class="dv">3</span>,]}</code></pre></div>
<p>Survey years specify the number of years of tagged fish releases to include in the tag release and recapture matrix that is used in the <code>multi_release</code> function that calculates the tagged fish available for recapture</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">Survey_years &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">min</span>(Release_data[[<span class="st">"SEASON"</span>]],<span class="dt">na.rm =</span> <span class="ot">TRUE</span>),<span class="kw">max</span>(Release_data[[<span class="st">"SEASON"</span>]],<span class="dt">na.rm =</span> <span class="ot">TRUE</span>),<span class="dv">1</span>)</code></pre></div>
<p>Release and recapture data are restricted to the target species and subset to include only columns of data that are required for the tag release and recapture matrix that is generated by the <code>extract_recaptures_season</code> function</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># for data that is input into tag release and recap matrix  remove non-target species</span>
Releases_input &lt;-Release_data<span class="op">$</span>SEASON[Release_data<span class="op">$</span>SPECIES_CODE<span class="op">%in%</span>target_species]

Recaps_input &lt;-<span class="st"> </span><span class="kw">cbind</span>(Recapture_data<span class="op">$</span>SEASON_RELEASE[Recapture_data<span class="op">$</span>SPECIES_CODE_RECAPTURE<span class="op">%in%</span>target_species],Recapture_data<span class="op">$</span>SEASON_RECAPTURE[Recapture_data<span class="op">$</span>SPECIES_CODE_RECAPTURE<span class="op">%in%</span>target_species])


tag_data_matrix &lt;-<span class="st"> </span><span class="kw"><a href="../reference/extract_recaptures_season.html">extract_recaptures_season</a></span>(<span class="dt">release_data =</span> Releases_input,<span class="dt">recapture_data=</span>Recaps_input,                              <span class="dt">release_seasons =</span> Survey_years)</code></pre></div>
<p>The tag release and recapture matrix created looks like this:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
tag_data_matrix
<span class="co">#&gt;   Year Releases 2015 2016 2017</span>
<span class="co">#&gt; 1 2015       50    0    0    2</span>
<span class="co">#&gt; 2 2016       50    0    0    2</span>
<span class="co">#&gt; 3 2017       50    0    0    0</span></code></pre></div>
<p>The first column includes the season of release, the second column the number of Releases in that season and the following columns are all the years of recaptures. In this example there were there were two recaptures that were released in 2015 and two recaptures that were released in 2016.</p>
<p>Survey est are the seasons for which at least one tagged fish recapture is available. In this example there are only recaptures in 2017</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># No estimates in years where there are zero recaptures </span>
Survey_est&lt;-<span class="st"> </span><span class="kw">unique</span>(Recapture_data<span class="op">$</span>SEASON_RECAPTURE)</code></pre></div>
<p>Annual estimates are made for each CCAMLR fishing season for which tagged fish recapture data are available and all parameter values that are used in calculating biomass are stored with each estimate in <code>store_annual_estimates</code>. For the simulate data example there is only a single year (2017) of tag recapture data included so there is only one annual estimate.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">store_annual_estimates&lt;-<span class="kw">data.frame</span>(<span class="kw">matrix</span>(<span class="dv">0</span>,<span class="dt">nrow=</span><span class="kw">length</span>(Survey_est),<span class="dt">ncol=</span><span class="dv">10</span>))
<span class="kw">names</span>(store_annual_estimates)=<span class="kw">c</span>(<span class="st">"Species"</span>,<span class="st">"RB"</span>,<span class="st">"Season"</span>,<span class="st">"N_recaptures"</span>,<span class="st">"Total_Catch"</span>,<span class="st">"RB_N_Hauls"</span>,<span class="st">"Avail_tags"</span>, <span class="st">"Est"</span>,<span class="st">"CI_lower"</span>,<span class="st">"CI_upper"</span>) 

## make sure catch data extracts only include target species data
store_annual_estimates<span class="op">$</span>Species &lt;-<span class="st"> </span><span class="kw">rep</span>(target_species,<span class="kw">length</span>(Survey_est))
store_annual_estimates<span class="op">$</span>RB &lt;-<span class="st"> </span><span class="kw">rep</span>(RB,<span class="kw">length</span>(Survey_est))
store_annual_estimates<span class="op">$</span>Season &lt;-<span class="st"> </span>Survey_est</code></pre></div>
<p>Variable <span class="math inline">\(y\)</span> is the survey year in <code>Survey_est</code> for which toothfish biomass can be estimated. Depending on whether <span class="math inline">\(y\)</span> is one or more years/seasons from the minimum year of tagged fish release it will need to be adjusted depending on the Research Block. In this example there are three years of tagged fish releases (i.e. 2015, 2016 &amp; 2017), and <code>Survey_est</code> is only one year (i.e. 2017). Consequently, the season_releases is not &gt; 3 years so it does not need to be adjusted.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">for</span> (y <span class="cf">in</span> Survey_est){
  
  <span class="co"># if Season releases is &gt; 3 then restrict it to the past three years</span>
  Season_releases &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="kw">min</span>(Survey_years),y,<span class="dv">1</span>)
  <span class="cf">if</span>(RB<span class="op">%in%</span><span class="kw">c</span>(<span class="st">"486_2"</span>,<span class="st">"RB_TOA"</span>) <span class="op">&amp;</span><span class="st"> </span><span class="kw">length</span>(Season_releases)<span class="op">&gt;</span><span class="dv">1</span>){
    <span class="co"># 1 years of releases are included as the 1 year prior to the current season (y) </span>
    <span class="co"># are used in calculating the tagged fish available for recapture</span>
    Season_releases &lt;-<span class="st"> </span><span class="kw">seq</span>(y<span class="op">-</span><span class="dv">1</span>,y,<span class="dv">1</span>)}<span class="cf">else</span>{
      <span class="cf">if</span>(<span class="kw">length</span>(Season_releases)<span class="op">&gt;</span><span class="dv">3</span>){
        <span class="co"># 4 years of releases are included as the 3 years prior to the current season (y) </span>
        <span class="co"># are used in calculating the tagged fish available for recapture</span>
        Season_releases &lt;-<span class="st"> </span><span class="kw">seq</span>(y<span class="op">-</span><span class="dv">3</span>,y,<span class="dv">1</span>)
      }
    }
  
}</code></pre></div>
<p>With the relevant season(s) of releases and catch data to include in the Research Block specified, the <code>extract_catch_data_tag_est</code> function uses the catch data and tagged fish release data from Research Blocks to format CPUE data for input into the CPUE_seabed function below. An example of how all the inputs for this function have been formatted are provided above, but for more information see ?<code>extract_catch_data_tag_est</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">haul_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/extract_catch_data_tag_est.html">extract_catch_data_tag_est</a></span>(<span class="dt">catch_data=</span>Catch_data,<span class="dt">release_data=</span>Release_data,
                                        <span class="dt">recapture_data=</span>Recapture_data,<span class="dt">measure=</span><span class="st">"weights"</span>,
                                        <span class="dt">target_species=</span>target_species,<span class="dt">release_seasons =</span>Season_releases,
                                        <span class="dt">catch_season =</span> y)</code></pre></div>
<p>The output <code>haul_data</code> has the <code>CAUGHT_KG_TOTAL</code> of substantial catch (i.e. retained catch + tagged and released fish from catch season <span class="math inline">\(y\)</span>) of each simulated haul in 2017 in the first column and each subsequent column has the number of simulated recaptures in 2017 by the year it was released for each haul. This has been formatted for the <code>multi_release</code> function which provides estimates based on the total number of recaptures irrespective of the release year, but also provides cohort based estimates using recaptures for each release event. The first six hauls of data from <code>haul_data</code> looks as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="kw">head</span>(haul_data)
<span class="co">#&gt;   CAUGHT_KG_TOTAL 2015 2016 2017</span>
<span class="co">#&gt; 1        231.2206    0    0    0</span>
<span class="co">#&gt; 2        318.7825    0    0    0</span>
<span class="co">#&gt; 3        302.7437    0    0    0</span>
<span class="co">#&gt; 4        269.0394    0    0    0</span>
<span class="co">#&gt; 5        277.5503    0    0    0</span>
<span class="co">#&gt; 6        221.5638    0    0    0</span></code></pre></div>
<p>Because there are very few recaptures per haul this will likely show zero or very few recaptures, but the sum across hauls shows there are two recaptures that were released in 2015 and two recaptures that were released in 2016</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">colSums</span>(haul_data)
<span class="co">#&gt; CAUGHT_KG_TOTAL            2015            2016            2017 </span>
<span class="co">#&gt;        56149.01            2.00            2.00            0.00</span></code></pre></div>
<p>The matrix of the total number of tagged fish releases and tag recaptures by season (<code>tag_data_matrix</code>) is indexed to include only the relevant seasons of releases and recaptures based on <code>Season_releases</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tags &lt;-<span class="st"> </span>tag_data_matrix[<span class="kw">match</span>(<span class="kw">min</span>(Season_releases),tag_data_matrix<span class="op">$</span>Year)<span class="op">:</span>(<span class="kw">match</span>(<span class="kw">max</span>(Season_releases),tag_data_matrix<span class="op">$</span>Year)<span class="op">-</span><span class="dv">1</span>),]
tags &lt;-<span class="st"> </span>tags[,<span class="kw">names</span>(tags)<span class="op">%in%</span><span class="kw">c</span>(<span class="st">"Releases"</span>,Season_releases)]</code></pre></div>
<p>The <code>multi_release</code> and <code>single_release</code> functions that are used to apply the Chapman mark-recapture biomass estimation method require a list of paramater values and specifications that are passed to these functions in tag_pars. These paramaters include a mean fish weight (<code>mean_wt</code>) which is set to zero as the mean fish weight is not included in the Chapman biomass estimation formula agreed at WG-SAM-16, the method to be used (as a Chapman and Peterson method can be specified), the units of the catch (which in this case is kg), the Ricker type of fishery (which in this case is type 1) and a number of other paramters i.e. natural mortality (<code>nat_mort</code>), tagging mortaility (<code>tag_mort</code>), tag reporting rate (<code>reporting</code>), tag shedding (<code>chronic_shed</code>) that can vary in relation to the <code>target_species</code>. For further details on paramater values for each species see above and for more detailed explanations of paramters see ?<code>multi_release</code> or ?<code>single_release</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## expanded tag_parameters
<span class="cf">if</span>(target_species<span class="op">%in%</span><span class="st">"TOP"</span>){
  tag_pars &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="st">"mean_wt"</span>=<span class="dv">0</span>, <span class="st">"method"</span>=<span class="st">"Chapman"</span>, <span class="st">"unit"</span>=<span class="st">"kg"</span>, <span class="st">"type"</span>=<span class="dv">1</span>,
                   <span class="st">"tag_mort"</span>=<span class="kw">rep</span>(<span class="fl">0.1</span>, <span class="kw">length</span>(Season_releases)), <span class="st">"reporting"</span>=<span class="kw">rep</span>(<span class="dv">1</span>,<span class="kw">length</span>(Season_releases)), 
                   <span class="st">"nat_mort"</span>=<span class="kw">rep</span>(<span class="fl">0.155</span>,<span class="kw">length</span>(Season_releases)), <span class="st">"chronic_shed"</span>=<span class="kw">rep</span>(<span class="fl">0.0084</span>,<span class="kw">length</span>(Season_releases)),
                   <span class="st">"chronic_mort"</span>=<span class="kw">rep</span>(<span class="dv">0</span>,<span class="kw">length</span>(Season_releases)))}<span class="cf">else</span>{
                     tag_pars &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="st">"mean_wt"</span>=<span class="dv">0</span>, <span class="st">"method"</span>=<span class="st">"Chapman"</span>, <span class="st">"unit"</span>=<span class="st">"kg"</span>, <span class="st">"type"</span>=<span class="dv">1</span>,
                                      <span class="st">"tag_mort"</span>=<span class="kw">rep</span>(<span class="fl">0.1</span>, <span class="kw">length</span>(Season_releases)),
                                      <span class="st">"reporting"</span>=<span class="kw">rep</span>(<span class="dv">1</span>,<span class="kw">length</span>(Season_releases)), 
                                      <span class="st">"nat_mort"</span>=<span class="kw">rep</span>(<span class="fl">0.13</span>,<span class="kw">length</span>(Season_releases)),
                                      <span class="st">"chronic_shed"</span>=<span class="kw">rep</span>(<span class="fl">0.0084</span>,<span class="kw">length</span>(Season_releases)),
                                      <span class="st">"chronic_mort"</span>=<span class="kw">rep</span>(<span class="dv">0</span>,<span class="kw">length</span>(Season_releases)))}</code></pre></div>
<p>If more that two release seasons are included then the <code>multi_release</code> function is required and if not then the <code>single_release</code> function is used. In the example from 5843a_1 the <code>multi_release</code> function is used as <code>Season_releases</code> &gt; 2</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="cf">if</span>(<span class="kw">length</span>(Season_releases)<span class="op">&gt;</span><span class="dv">2</span>){
  
  ## now run the model
  obj &lt;-<span class="st"> </span><span class="kw"><a href="../reference/multi_release.html">multi_release</a></span>(tags, <span class="dt">hauls=</span>haul_data, <span class="dt">pars=</span>tag_pars)
  test_boot &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tag_bootstrap.html">tag_bootstrap</a></span>(obj,n_boot,<span class="dt">boot_zeroes=</span><span class="ot">TRUE</span>)
  
  store_annual_estimates<span class="op">$</span>N_recaptures[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span><span class="kw">sum</span>(tags[,<span class="kw">ncol</span>(tags)])
  store_annual_estimates<span class="op">$</span>Avail_tags[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span><span class="kw">sum</span>(obj<span class="op">$</span>Avail_tags[,<span class="kw">ncol</span>(obj<span class="op">$</span>Avail_tags)])
  store_annual_estimates<span class="op">$</span>Total_Catch[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span><span class="kw">sum</span>(haul_data[,<span class="dv">1</span>])<span class="op">/</span><span class="fl">1e3</span>
  store_annual_estimates<span class="op">$</span>RB_N_Hauls[Survey_est<span class="op">%in%</span>y] &lt;-<span class="kw">nrow</span>(haul_data)   
  store_annual_estimates<span class="op">$</span>Est[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span><span class="kw">summary</span>(test_boot)[<span class="st">"Combined"</span>]<span class="op">/</span><span class="fl">1e3</span>
  store_annual_estimates<span class="op">$</span>CI_lower[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span><span class="kw">summary</span>(test_boot)[<span class="st">"2.5%"</span>]<span class="op">/</span><span class="fl">1e3</span>  
  store_annual_estimates<span class="op">$</span>CI_upper[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span><span class="kw">summary</span>(test_boot)[<span class="st">"97.5%"</span>]<span class="op">/</span><span class="fl">1e3</span> 
  
}<span class="cf">else</span>{
  obj &lt;-<span class="st"> </span><span class="kw"><a href="../reference/single_release.html">single_release</a></span>(<span class="dt">tags=</span><span class="kw">as.numeric</span>(tags[<span class="dv">1</span>]), <span class="dt">catch=</span>haul_data[,<span class="dv">1</span>], <span class="dt">recaps=</span>haul_data[,<span class="kw">ncol</span>(haul_data)<span class="op">-</span><span class="dv">1</span>],
                        <span class="dt">method=</span>tag_pars[[<span class="st">"method"</span>]],<span class="dt">unit=</span>tag_pars[[<span class="st">"unit"</span>]],
                        <span class="dt">type=</span>tag_pars[[<span class="st">"type"</span>]],<span class="dt">tag_mort =</span> tag_pars[[<span class="st">"tag_mort"</span>]][<span class="dv">1</span>],
                        <span class="dt">reporting =</span> tag_pars[[<span class="st">"reporting"</span>]][<span class="dv">1</span>],<span class="dt">nat_mort =</span> tag_pars[[<span class="st">"nat_mort"</span>]][<span class="dv">1</span>],
                        <span class="dt">chronic_shed =</span> tag_pars[[<span class="st">"chronic_shed"</span>]][<span class="dv">1</span>],<span class="dt">chronic_mort =</span> tag_pars[[<span class="st">"chronic_mort"</span>]][<span class="dv">1</span>])
  
  test_boot &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tag_bootstrap.html">tag_bootstrap</a></span>(obj,n_boot,<span class="dt">boot_zeroes=</span><span class="ot">TRUE</span>)
  
  store_annual_estimates<span class="op">$</span>N_recaptures[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span><span class="kw">sum</span>(haul_data[,<span class="kw">ncol</span>(haul_data)<span class="op">-</span><span class="dv">1</span>])
  store_annual_estimates<span class="op">$</span>Avail_tags[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span>obj<span class="op">$</span>TagsAvailable
  store_annual_estimates<span class="op">$</span>Total_Catch[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span><span class="kw">sum</span>(haul_data[,<span class="dv">1</span>])<span class="op">/</span><span class="fl">1e3</span>
  store_annual_estimates<span class="op">$</span>RB_N_Hauls[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span><span class="kw">nrow</span>(haul_data)
  store_annual_estimates<span class="op">$</span>Est[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span><span class="kw">summary</span>(test_boot)[[<span class="st">"N_hat"</span>]]<span class="op">/</span><span class="fl">1e3</span>
  store_annual_estimates<span class="op">$</span>CI_lower[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span><span class="kw">summary</span>(test_boot)[[<span class="st">"2.5%"</span>]]<span class="op">/</span><span class="fl">1e3</span>
  store_annual_estimates<span class="op">$</span>CI_upper[Survey_est<span class="op">%in%</span>y] &lt;-<span class="st"> </span><span class="kw">summary</span>(test_boot)[[<span class="st">"97.5%"</span>]]<span class="op">/</span><span class="fl">1e3</span>
  
}


<span class="co"># store Chapman estimates with inputs</span>

store_biomass_estimates_chapman &lt;-<span class="kw">subset</span>(store_annual_estimates,<span class="dt">select=</span><span class="kw">c</span>(RB,Species,Season,Est,CI_lower,
                                                                         CI_upper,N_recaptures,RB_N_Hauls))
store_biomass_estimates_chapman<span class="op">$</span>Method &lt;-<span class="st"> </span><span class="kw">rep</span>(<span class="st">"Chapman"</span>,<span class="kw">nrow</span>(store_biomass_estimates_chapman))</code></pre></div>
</div>
<div id="example-presentation-of-biomass-estimates" class="section level2">
<h2 class="hasAnchor">
<a href="#example-presentation-of-biomass-estimates" class="anchor"></a>Example presentation of biomass estimates</h2>
<p>To present results in both table form and plots we combined the dataframes that stored the CPUE-by-seabed area estimates with the Chapman mark-recapture estimates. While the worked examples provided above only included a CPUE-by-seabed area estimate for RB_TOA and Chapman mark-recapture biomass estimate for RB_TOP, both biomass estimates were generated for both Research blocks for completeness and comparison in the results below.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
store_B_est_all &lt;-<span class="st"> </span><span class="kw">rbind</span>(store_biomass_estimates_chapman,<span class="kw">data.frame</span>(store_biomass_estimates_CPUE,<span class="dt">N_recaptures=</span><span class="kw">rep</span>(<span class="ot">NA</span>,<span class="kw">nrow</span>(store_biomass_estimates_CPUE))))</code></pre></div>
<p>Point biomass estimates from both methods with upper and lower confidence intervals are shown in the table below</p>
<div id="install-and-load-ggplot2-package-" class="section level3">
<h3 class="hasAnchor">
<a href="#install-and-load-ggplot2-package-" class="anchor"></a>Install and load ggplot2 package.</h3>
<p>The ggplot2 package provides nice plots with confidence intervals</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># install.packages("ggplot2")</span>
<span class="kw">library</span>(ggplot2)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># remove hauls and catch limit </span>
store_B_est_all &lt;-<span class="st"> </span><span class="kw">subset</span>(store_B_est_all, <span class="dt">select=</span><span class="op">-</span><span class="kw">c</span>(RB_N_Hauls,Season))
store_B_est_all  &lt;-<span class="st"> </span>store_B_est_all[<span class="kw">order</span>(store_B_est_all<span class="op">$</span>RB),]
<span class="kw">row.names</span>(store_B_est_all)&lt;-<span class="st"> </span><span class="ot">NULL</span>

store_B_est_all
<span class="co">#&gt;       RB Species       Est  CI_lower  CI_upper N_recaptures</span>
<span class="co">#&gt; 1 RB_TOA     TOA 1462.6286  814.3363 3622.1515            6</span>
<span class="co">#&gt; 2 RB_TOA     TOA  461.1953  388.9808  543.8752           NA</span>
<span class="co">#&gt; 3 RB_TOP     TOP  809.1233  425.6425 2086.9956            4</span>
<span class="co">#&gt; 4 RB_TOP     TOP 1361.3481 1162.7674 1605.8745           NA</span>
<span class="co">#&gt;                Method</span>
<span class="co">#&gt; 1             Chapman</span>
<span class="co">#&gt; 2 CPUE-by-seabed area</span>
<span class="co">#&gt; 3             Chapman</span>
<span class="co">#&gt; 4 CPUE-by-seabed area</span></code></pre></div>
</div>
</div>
<div id="compare-biomass-estimates-with-confidence-intervals-using-the-two-different-methods" class="section level2">
<h2 class="hasAnchor">
<a href="#compare-biomass-estimates-with-confidence-intervals-using-the-two-different-methods" class="anchor"></a>Compare biomass estimates with confidence intervals using the two different methods</h2>
<p>A plot of the point biomass estimates with confidence intervals in each Research Blocks is also provided for visual comparison.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
<span class="co"># Plot biomass estimate time series per species and research block</span>

Plot_data=store_B_est_all
Plot_data=Plot_data[Plot_data<span class="op">$</span>RB<span class="op">%in%</span><span class="kw">unique</span>(Plot_data<span class="op">$</span>RB[Plot_data<span class="op">$</span>Method<span class="op">%in%</span><span class="st">"Chapman"</span>]),]
limits=ggplot2<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">ymin=</span>CI_lower,<span class="dt">ymax =</span>CI_upper)
dodge =<span class="st"> </span>ggplot2<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/position_dodge">position_dodge</a></span>(<span class="dt">width=</span><span class="fl">0.5</span>)
p=ggplot2<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/ggplot">ggplot</a></span>(Plot_data,<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">x=</span><span class="kw">as.factor</span>(Method),<span class="dt">y=</span>Est,<span class="dt">color=</span>Method,<span class="dt">group=</span>Method,<span class="dt">label=</span>N_recaptures)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_point">geom_point</a></span>(<span class="dt">position =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/position_dodge">position_dodge</a></span>(<span class="dt">width=</span><span class="fl">0.5</span>)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_text">geom_text</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">label=</span><span class="kw">ifelse</span>(<span class="kw">is.na</span>(N_recaptures),<span class="st">""</span>,N_recaptures)),
            <span class="dt">hjust=</span><span class="op">-</span><span class="fl">0.5</span>,<span class="dt">vjust=</span><span class="op">-</span><span class="dv">1</span>,<span class="dt">color=</span><span class="st">"black"</span>,
            <span class="dt">size=</span><span class="dv">2</span>) <span class="op">+</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/geom_linerange">geom_errorbar</a></span>(<span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/aes">aes</a></span>(<span class="dt">ymin=</span>CI_lower,<span class="dt">ymax =</span>CI_upper), 
                                   <span class="dt">position=</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/position_dodge">position_dodge</a></span>(<span class="dt">width=</span><span class="fl">0.5</span>), <span class="dt">width=</span><span class="fl">0.25</span>,<span class="dt">color=</span><span class="st">"black"</span>)<span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/facet_wrap">facet_wrap</a></span>(<span class="op">~</span>RB,<span class="dt">scales=</span><span class="st">"free_y"</span>)<span class="op">+</span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">ylab</a></span>(<span class="st">"Estimated Biomass(t)"</span>) <span class="op">+</span><span class="st"> </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/labs">xlab</a></span>(<span class="st">"Method"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/scale_discrete">scale_x_discrete</a></span>(<span class="dt">expand =</span> <span class="kw">c</span>(<span class="fl">0.1</span>,<span class="fl">0.1</span>)) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/theme">theme</a></span>(<span class="dt">axis.text.x =</span> <span class="kw"><a href="http://www.rdocumentation.org/packages/ggplot2/topics/element">element_text</a></span>(<span class="dt">angle =</span> <span class="dv">45</span>, <span class="dt">vjust =</span> <span class="dv">1</span>, <span class="dt">hjust=</span><span class="dv">1</span>),<span class="dt">legend.position =</span> <span class="st">"none"</span>)
<span class="kw">print</span>(p)</code></pre></div>
<p><img src="BERT-CCAMLR_files/figure-html/unnamed-chunk-44-1.png" width="576"></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#ccamlr-data-required-for-local-toothfish-biomass-estimation">CCAMLR data required for local toothfish biomass estimation</a></li>
      <li><a href="#simulated-data">Simulated data</a></li>
      <li><a href="#estimating-weight-of-released-tagged-fish-from-observer-length-weight-data">Estimating weight of released tagged fish from observer length-weight data</a></li>
      <li><a href="#cpue-by-seabed-area-biomass-estimation">CPUE-by-seabed area biomass estimation</a></li>
      <li><a href="#cpue-by-seabed-area-biomass-estimation-of-antarctic-toothfish-in-research-block-rb_toa">CPUE-by-seabed area biomass estimation of Antarctic toothfish in Research Block RB_TOA</a></li>
      <li><a href="#chapman-mark-recapture-estimator">Chapman mark-recapture estimator</a></li>
      <li><a href="#chapman-mark-recapture-biomass-estimation-of-patagonian-toothfish-in-research-block-rb_top">Chapman mark-recapture biomass estimation of Patagonian toothfish in Research Block RB_TOP</a></li>
      <li><a href="#example-presentation-of-biomass-estimates">Example presentation of biomass estimates</a></li>
      <li><a href="#compare-biomass-estimates-with-confidence-intervals-using-the-two-different-methods">Compare biomass estimates with confidence intervals using the two different methods</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Paul Burch, Lucy Robinson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
